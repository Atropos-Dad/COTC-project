# Metrics Collection System

This document describes the metrics collection system architecture in the data collector module.

## Architecture Overview

The metrics system follows a standardized approach built around these key components:

1. **Metric Models**: Standardized data structures for metrics
2. **Metrics Generators**: Components that produce metrics
3. **Metrics Senders**: Components that send metrics to destinations

## Components

### Metric Models

- `GenericMetric`: Standard representation for all metrics with unified fields:
  - `origin`: Source of the metric (e.g., "system", "game")
  - `metric_type`: Type of metric (e.g., "cpu", "memory", "move")
  - `value`: Numeric value
  - `timestamp`: When the metric was recorded
  - `metadata`: Additional context for the metric

- `SystemMetrics`: Specialized model for system performance metrics

### Metrics Generators

All metrics generators implement the `MetricsGenerator` protocol, which defines:

- `generate_metrics()`: Async generator that yields metrics in time-series format

Specific generators:

- `GenericMetricsGenerator`: Allows manual addition of metrics through a queue
- `SystemMetricsGenerator`: Collects system performance metrics at regular intervals
- `LichessMetricsCollector`: Collects chess game metrics from Lichess

### Metrics Senders

- `GenericMetricsSender`: Client that sends metrics to the server either:
  - Asynchronously via websockets (preferred method)
  - Synchronously via HTTP requests (fallback method)

## Data Flow

1. **Generation**: Metrics are generated by implementations of `MetricsGenerator`
2. **Conversion**: All metrics are converted to standardized `GenericMetric` objects
3. **Formatting**: Metrics are formatted for time-series storage using `to_timeseries_format()`
4. **Collection**: `AsyncMetricsCollector` collects metrics from generators
5. **Transmission**: Metrics are sent to the server via websockets or HTTP

## Usage

### Adding a New Metric Type

1. Create a new metric generator that implements the `MetricsGenerator` protocol
2. Convert your domain-specific metrics to `GenericMetric` objects
3. Configure the generator in `main.py`

### Manual Metric Generation

```python
from data_collector.models import GenericMetric
from data_collector.metrics_sender import GenericMetricsSender

# Create a metrics sender
sender = GenericMetricsSender(endpoint_url="ws://localhost:5000/ws/metrics")
await sender.start()

# Create and send a metric
metric = GenericMetric(
    origin="application",
    metric_type="event",
    value=1.0,
    metadata={"event_name": "user_login"}
)
await sender.send_metric(metric)
```

## Testing

Unit tests for the metrics system are in `tests/test_metrics.py`. Run with pytest:

```
pytest tests/test_metrics.py
```
